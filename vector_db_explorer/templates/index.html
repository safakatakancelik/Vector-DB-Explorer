{% extends "layout.html" %}

{% block content %}

<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>




<!-- 1. VISUALIZATION  -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div class="plot-container">
        {% if plot_div %}
        {{ plot_div | safe }}
        {% else %}
        <div style="padding: 20px; text-align: center; color: #666;">Waiting for data...</div>
        {% endif %}
    </div>
</div>


<!-- 2. SIMILARITY SEARCH -->
<div class="card">
    <h2>SIMILARITY SEARCH</h2>
    <form action="/" method="post" style="display: flex; gap: 10px;">
        <input type="text" name="query" value="{{ query if query else '' }}" placeholder="INPUT SEARCH QUERY..."
            autofocus>
        <button type="submit">SEARCH</button>
    </form>

    {% if results %}
    <div style="margin-top: 15px;">
        <h3 style="font-size: 0.9em; color: var(--success-color);">MATCHES FOUND: {{ results|length }}</h3>
        {% for res in results %}
        <div class="results-item">
            <div
                style="display: flex; justify-content: space-between; font-size: 0.8em; color: var(--core-color); margin-bottom: 3px;">
                <span>ID: {{ res.id[:8] }}...</span>
                <span>DIST: {{ "%.4f"|format(res.distance) }}</span>
            </div>
            <div style="font-size: 0.95em; line-height: 1.3;">{{ res.document }}</div>
            <div style="font-size: 0.7em; color: #666; margin-top: 3px;">{{ res.metadata }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>



<!-- 3. DATA INGESTION -->
<div class="card">
    <h2>DATA INGESTION</h2>
    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <form action="/upload" method="post" enctype="multipart/form-data"
                style="display: flex; gap: 10px; align-items: center;">
                <input type="file" name="files" multiple id="fileIdx" style="color: #888;">
                <button type="submit">UPLOAD FILES</button>
            </form>
        </div>
        <div style="flex: 1;">
            <form action="/add_text" method="post" style="display: flex; gap: 10px;">
                <input type="text" name="text" placeholder="Text Input as a Chunk">
                <button type="submit">ADD</button>
            </form>
        </div>
    </div>
</div>







<!-- 4. All Chunks -->
<div class="card">
    <h2>All Chunks</h2>

    <div style="margin-bottom: 20px; width: 100%;">
        <input type="text" id="filter-chunks" placeholder="Filter chunks..."
            style="padding: 8px; border: 1px solid #333; background: #000; color: #fff; width: 100%; box-sizing: border-box;">
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
            <tr style="border-bottom: 1px solid #333; text-align: left;">
                <th style="padding: 10px; color: var(--core-color);">ID</th>
                <th style="padding: 10px; color: var(--core-color);">CONTENT</th>
                <th style="padding: 10px; color: var(--core-color);">SOURCE</th>
            </tr>
        </thead>
        <tbody id="chunks-table-body">
            <!-- Rows injected by JS -->
        </tbody>
    </table>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div id="page-info">Page 1</div>
        <div style="display: flex; gap: 10px;">
            <button id="prev-btn" onclick="changePage(-1)" disabled
                style="background: #333; color: #fff; border: none; padding: 5px 15px; cursor: pointer;">PREV</button>
            <button id="next-btn" onclick="changePage(1)"
                style="background: #333; color: #fff; border: none; padding: 5px 15px; cursor: pointer;">NEXT</button>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let currentQuery = "";

    document.getElementById('filter-chunks').addEventListener('input', debounce((e) => {
        currentQuery = e.target.value;
        currentPage = 1;
        fetchChunks();
    }, 300));

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function changePage(delta) {
        currentPage += delta;
        fetchChunks();
    }

    async function fetchChunks() {
        const res = await fetch(`/api/chunks?page=${currentPage}&query=${encodeURIComponent(currentQuery)}`);
        const data = await res.json();

        renderTable(data.data);
        updatePagination(data);
    }

    function renderTable(data) {
        const tbody = document.getElementById('chunks-table-body');
        tbody.innerHTML = '';

        if (!data.ids || data.ids.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #666;">No results found</td></tr>';
            return;
        }

        data.ids.forEach((id, index) => {
            const doc = data.documents[index];
            const meta = data.metadatas[index];
            const source = meta ? meta.source : 'N/A';

            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #222';
            tr.innerHTML = `
                <td style="padding: 10px; font-family: monospace; color: #888;">${id.substring(0, 8)}...</td>
                <td style="padding: 10px;">
                    <div class="no-scrollbar" style="max-height: 100px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;">${escapeHtml(doc)}</div>
                </td>
                <td style="padding: 10px; font-size: 0.8em; color: #888;">${escapeHtml(source)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updatePagination(data) {
        const totalPages = Math.ceil(data.total / data.per_page);
        document.getElementById('page-info').textContent = `Page ${data.page} of ${totalPages || 1} (Total: ${data.total})`;

        document.getElementById('prev-btn').disabled = data.page <= 1;
        document.getElementById('prev-btn').style.opacity = data.page <= 1 ? 0.5 : 1;

        document.getElementById('next-btn').disabled = data.page >= totalPages;
        document.getElementById('next-btn').style.opacity = data.page >= totalPages ? 0.5 : 1;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Initial load
    fetchChunks();
</script>
{% endblock %}